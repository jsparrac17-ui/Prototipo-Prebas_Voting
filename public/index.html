<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema WiSe - Monitor de Votaci√≥n</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f4f4f9; text-align: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; }
        .stats { display: flex; justify-content: space-around; margin-top: 20px; font-size: 20px; flex-wrap: wrap; gap: 10px; }
        .big-number { font-size: 40px; font-weight: bold; color: #2c3e50; }
        #log { height: 140px; overflow-y: scroll; background: #222; color: #0f0; text-align: left; padding: 10px; margin-top: 20px; font-family: monospace; }
        .controls { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; text-align: left; }
        .controls label { font-weight: bold; display: block; margin-bottom: 4px; }
        .controls input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
        .controls button { padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #2196f3; color: #fff; }
        .btn-danger { background: #e53935; color: #fff; }
        .status { padding: 10px; border-radius: 6px; background: #eef2ff; color: #2c3e50; margin-top: 8px; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="card">
        <h1>üó≥Ô∏è Resultados en Vivo</h1>

        <div style="height: 420px;">
            <canvas id="miGrafica"></canvas>
        </div>

        <div class="stats">
            <div>SI: <span id="count-si" class="big-number" style="color: #4caf50">0</span></div>
            <div>NO: <span id="count-no" class="big-number" style="color: #f44336">0</span></div>
            <div>AB: <span id="count-ab" class="big-number" style="color: #ffb300">0</span></div>
        </div>

        <div class="controls" style="margin-top: 20px;">
            <div>
                <label>Control de r√°fagas (ESP32 Super-Mini)</label>
                <button class="btn-primary" onclick="iniciarRafaga()">Iniciar r√°faga</button>
                <button class="btn-danger" style="margin-left:8px;" onclick="detenerRafaga()">Detener r√°faga</button>
                <div id="estado-control" class="status">Esperando comando...</div>
            </div>
            <div>
                <label>Votaci√≥n</label>
                <button onclick="resetear()" style="padding:10px 20px; cursor:pointer;">Reiniciar Votaci√≥n</button>
                <button onclick="descargarLog()" style="padding:10px 20px; cursor:pointer; margin-left:8px;">Descargar log</button>
                <div id="estado-log" class="status" style="margin-top:8px;">Log listo (√∫ltima votaci√≥n).</div>
            </div>
        </div>

        <p style="margin-top:16px; color:#555;">
            Los votos recibidos provienen √∫nicamente de los controles ESP32 Super-Mini; la p√°gina no genera votos simulados.
        </p>
    </div>

    <div id="log">Esperando conexi√≥n...</div>

    <script>
        const socket = io(); // Conexi√≥n con el servidor Node.js

        // Datos iniciales
        let votosSI = 0;
        let votosNO = 0;
        let votosAB = 0;
        let idsVotaron = new Set(); // Para evitar votos dobles

        // Configuraci√≥n de la Gr√°fica
        const ctx = document.getElementById('miGrafica').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['SI (Aprobado)', 'NO (Rechazado)', 'AB (Abstenci√≥n)'],
                datasets: [{
                    label: '# de Votos',
                    data: [0, 0, 0],
                    backgroundColor: ['#4caf50', '#f44336', '#ffb300'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // --- ESCUCHAR EVENTOS DEL SERVIDOR (USB o simulaci√≥n) ---
        socket.on('nuevo-voto', (data) => {
            // data = { id: 101, voto: 1 }

            // Evitar doble voto (opcional, l√≥gica simple)
/*            if (idsVotaron.has(data.id)) {
                log(`‚ö†Ô∏è El ID ${data.id} intent√≥ votar de nuevo.`);
                return;
            }
            idsVotaron.add(data.id); */

            // Contabilizar
            if (data.voto === 1) votosSI++;
            else if (data.voto === 2) votosNO++;
            else if (data.voto === 3) votosAB++;
            // (Si usas teclado matricial: 10=A, 11=B, ajusta esto)

            // Actualizar Interfaz
            actualizarUI();
            log(`‚úÖ Voto recibido del ID: ${data.id} (valor ${data.voto})`);
        });

        function actualizarUI() {
            // Actualizar n√∫meros
            document.getElementById('count-si').innerText = votosSI;
            document.getElementById('count-no').innerText = votosNO;
            document.getElementById('count-ab').innerText = votosAB;

            // Actualizar gr√°fica
            chart.data.datasets[0].data = [votosSI, votosNO, votosAB];
            chart.update();
        }

        async function resetear() {
            try {
                const resp = await fetch('/api/reset-log', { method: 'POST' });
                if (!resp.ok) {
                    throw new Error(`Servidor devolvi√≥ ${resp.status}`);
                }

                votosSI = 0;
                votosNO = 0;
                votosAB = 0;
                idsVotaron.clear();
                actualizarUI();

                document.getElementById('estado-log').innerText = 'Historial borrado. Registrando solo la √∫ltima votaci√≥n.';
                log("üîÑ Votaci√≥n reiniciada y log en servidor limpiado");
            } catch (err) {
                log(`‚ùå No se pudo reiniciar el log: ${err.message}`);
            }
        }

        function iniciarRafaga() {
            socket.emit('start-flood');
            document.getElementById('estado-control').innerText = 'Solicitando inicio de r√°faga...';
            log('üöÄ Comando START enviado a los controles');
        }

        function detenerRafaga() {
            socket.emit('stop-flood');
            document.getElementById('estado-control').innerText = 'Solicitando detenci√≥n de r√°faga...';
            log('‚èπÔ∏è  Comando STOP enviado a los controles');
        }

        function descargarLog() {
            window.open('/api/votes-log', '_blank');
            document.getElementById('estado-log').innerText = 'Descargando CSV de la √∫ltima votaci√≥n...';
            log('üì• Solicitando descarga del log (CSV) de la √∫ltima votaci√≥n');
        }

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML = `> ${msg}<br>` + div.innerHTML;
        }
    </script>
</body>
</html>
