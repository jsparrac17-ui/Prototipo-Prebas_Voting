<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema WiSe - Monitor de Votaci√≥n</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f4f4f9; text-align: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        h1 { color: #333; }
        .stats { display: flex; justify-content: space-around; margin-top: 20px; font-size: 20px; }
        .big-number { font-size: 40px; font-weight: bold; color: #2c3e50; }
        #log { height: 100px; overflow-y: scroll; background: #222; color: #0f0; text-align: left; padding: 10px; margin-top: 20px; font-family: monospace; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="card">
        <h1>üó≥Ô∏è Resultados en Vivo</h1>
        
        <div style="height: 400px;">
            <canvas id="miGrafica"></canvas>
        </div>

        <div class="stats">
            <div>SI: <span id="count-si" class="big-number" style="color: #4caf50">0</span></div>
            <div>NO: <span id="count-no" class="big-number" style="color: #f44336">0</span></div>
        </div>
        
        <button onclick="resetear()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">Reiniciar Votaci√≥n</button>
    </div>

    <div id="log">Esperando conexi√≥n...</div>

    <script>
        const socket = io(); // Conexi√≥n con el servidor Node.js
        
        // Datos iniciales
        let votosSI = 0;
        let votosNO = 0;
        let idsVotaron = new Set(); // Para evitar votos dobles

        // Configuraci√≥n de la Gr√°fica
        const ctx = document.getElementById('miGrafica').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['SI (Aprobado)', 'NO (Rechazado)'],
                datasets: [{
                    label: '# de Votos',
                    data: [0, 0],
                    backgroundColor: ['#4caf50', '#f44336'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // --- ESCUCHAR EVENTOS DEL SERVIDOR (USB) ---
        socket.on('nuevo-voto', (data) => {
            // data = { id: 101, voto: 1 }
            
            // Evitar doble voto (opcional, l√≥gica simple)
 /*            if (idsVotaron.has(data.id)) {
                log(`‚ö†Ô∏è El ID ${data.id} intent√≥ votar de nuevo.`);
                return;
            }
            idsVotaron.add(data.id); */

            // Contabilizar
            if (data.voto === 1) votosSI++;
            else if (data.voto === 2) votosNO++;
            // (Si usas teclado matricial: 10=A, 11=B, ajusta esto)

            // Actualizar Interfaz
            actualizarUI();
            log(`‚úÖ Voto recibido del ID: ${data.id}`);
        });

        function actualizarUI() {
            // Actualizar n√∫meros
            document.getElementById('count-si').innerText = votosSI;
            document.getElementById('count-no').innerText = votosNO;

            // Actualizar gr√°fica
            chart.data.datasets[0].data = [votosSI, votosNO];
            chart.update();
        }

        function resetear() {
            votosSI = 0;
            votosNO = 0;
            idsVotaron.clear();
            actualizarUI();
            log("üîÑ Votaci√≥n reiniciada");
        }

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML = `> ${msg}<br>` + div.innerHTML;
        }
    </script>
</body>
</html>